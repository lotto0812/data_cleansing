# 住所正規化・緯度経度変換システム 引継ぎ資料

## 概要
このドキュメントは、住所正規化と緯度経度変換システムの開発経緯、技術仕様、運用手順を詳細に記載した引継ぎ資料です。

## 開発経緯と変更履歴

### プロジェクトの整理（2024年）
- 大量の実験的・テスト用ファイルが存在していた状態から、本番運用に必要なコアファイルのみに整理
- 不要なファイル（約30個）をtemp_backupフォルダに移動後、最終的に削除
- .gitignoreの整備により、今後の不要ファイル蓄積を防止

### 主要な技術的改善
1. **都道府県処理の改善**
   - "不明"等の無効な都道府県名の適切な処理
   - 47都道府県の正式名称リストによる妥当性チェック実装

2. **市区町村マッピングの活用**
   - 市区町村マッピング.json（2,114件の合併履歴データ）の適切な読み込み
   - ハードコードされた変更履歴から外部ファイルベースへの移行

3. **データ処理の完全性確保**
   - マッチしなかったデータも結果ファイルに含める仕様に変更
   - match_status フィールドによる処理結果の明確化

## システム構成

### コアファイル
```
├── convert_addresses.py      # メイン実行スクリプト
├── gsi_geocoder.py          # 国土地理院API処理
├── address_utils.py         # 住所処理ユーティリティ
├── normalize_address.py     # AddressNormalizerクラス（テスト用）
├── 市区町村マッピング.json  # 合併履歴データ（2,164件）
├── requirements.txt         # 依存関係
├── README.md               # 基本説明
├── .gitignore              # Git除外設定
└── LICENSE                 # ライセンス
```

### 処理フロー
```
convert_addresses.py
    ↓
gsi_geocoder.py (process_dataframe)
    ↓
address_utils.py (各種ユーティリティ関数)
    ↓
国土地理院API + 市区町村マッピング.json
```

## 技術仕様

### 入力データ形式
CSVファイルで以下の列を想定：
- `SAKAYA_DEALER_CODE`: 店舗コード
- `SAKAYA_DEALER_NAME`: 店舗名
- `PREFECTURE`: 都道府県（空白や"不明"の可能性あり）
- `ADDRESS`: 住所

### 出力データ形式
入力データに以下の列が追加：
- `normalized_address`: 正規化された住所
- `matched_address`: 国土地理院でマッチした住所
- `latitude`: 緯度
- `longitude`: 経度
- `similarity`: 類似度（0.0～1.0）
- `chome_match`: 丁目レベルでのマッチ（True/False）
- `banchi_match`: 番地レベルでのマッチ（True/False）
- `go_match`: 号レベルでのマッチ（True/False）
- `match_status`: マッチング状態（'matched', 'unmatched', 'missing_address'）

### 都道府県処理ロジック
```python
# 都道府県を住所に追加する条件：
1. pd.notna(row['PREFECTURE'])  # 都道府県が存在
2. pd.notna(row['ADDRESS'])     # 住所が存在
3. is_valid_prefecture(str(row['PREFECTURE']))  # 有効な都道府県名
4. not str(row['ADDRESS']).startswith(str(row['PREFECTURE']))  # 重複回避
```

### 有効な都道府県リスト
47都道府県の正式名称のみを有効とする：
- 北海道、青森県、岩手県、...、沖縄県
- "不明"、略称、誤字等は無効として処理

## 重要な技術的決定事項

### 1. キャッシュ機能
- `geocoding_cache.json` に結果をキャッシュ
- APIコール回数の削減とパフォーマンス向上
- キャッシュファイルが存在しない場合でもエラーにならない設計

### 2. エラーハンドリング
- 住所が欠損している場合: `match_status = 'missing_address'`
- マッチしなかった場合: `match_status = 'unmatched'`
- マッチした場合: `match_status = 'matched'`
- すべてのケースで結果ファイルに含める

### 3. APIレート制限対応
- キャッシュヒットしない場合のみ0.5秒待機
- バッチ処理による大量データ対応

### 4. 数字正規化
- 全角数字→半角数字の変換
- 丁目・番地・号の前の漢数字のみをアラビア数字に変換
- 地名等の漢数字は保持（例：「三重県」は変換しない）

## テスト済みパターン

### 成功例
1. **政令指定都市の処理**
   - さいたま市（類似度: 0.747）
   - 静岡市（類似度: 0.933）
   - 横浜市（正常処理）

2. **都道府県処理パターン**
   - 都道府県あり + 住所: 正常結合
   - 都道府県なし + 都道府県名含む住所: そのまま使用
   - 都道府県"不明" + 住所: 住所のみ使用

3. **特殊ケース**
   - 諫早市（以前の問題ケース）: 類似度0.9で正常処理
   - 大阪市: 正常処理
   - 新宿区: 正常処理

## 運用手順

### 1. 基本実行
```bash
# 必要な依存関係のインストール
pip install -r requirements.txt

# メイン処理の実行
python convert_addresses.py
```

### 2. 入力ファイルの準備
- ファイル名: `sample_restaurants.csv`
- エンコーディング: UTF-8
- 必須列: ADDRESS
- 任意列: SAKAYA_DEALER_CODE, SAKAYA_DEALER_NAME, PREFECTURE

### 3. 出力ファイル
- 形式: `geocoding_results_YYYYMMDDHHMM_batch_NN.csv`
- バッチサイズ: 10,000件（変更可能）
- 低類似度アラート: 類似度0.2未満でコンソール表示

### 4. キャッシュ管理
- キャッシュファイル: `geocoding_cache.json`
- 削除により強制的な再処理が可能
- 本番環境では保持推奨（API呼び出し削減のため）

## トラブルシューティング

### よくある問題
1. **キャッシュファイル関連**
   - 症状: ファイル読み込みエラー
   - 対処: キャッシュファイルを削除して再実行

2. **文字化け**
   - 症状: 出力ファイルの文字化け
   - 対処: UTF-8対応エディタで開く（Windows標準のtypeコマンドは文字化けする）

3. **API制限**
   - 症状: 大量データ処理時のエラー
   - 対処: バッチサイズを小さくする、待機時間を増やす

### ログ確認
- 低類似度データは自動的にコンソール出力
- 処理進捗はリアルタイム表示
- エラーはコンソールに出力

## 保守・拡張ポイント

### 定期的なメンテナンス
1. **市区町村マッピングの更新**
   - 新しい合併情報の追加
   - 市区町村マッピング.json の更新

2. **都道府県リストの確認**
   - 法改正等による変更の確認（稀）

### 拡張可能性
1. **他のジオコーディングAPI対応**
   - GoogleMaps API等の追加
   - address_utils.pyの関数は再利用可能

2. **処理結果の詳細分析**
   - 類似度分布の解析
   - マッチングレベル別の統計

## 依存関係詳細

### Python パッケージ
```
pandas>=1.3.0
requests>=2.25.1
```

### 外部API
- 国土地理院 住所検索API
- URL: https://msearch.gsi.go.jp/address-search/AddressSearch
- 制限: 過度なアクセスは控える（0.5秒間隔で実装済み）

## セキュリティ考慮事項
- 入力データの個人情報は住所のみ（個人名等は含まない想定）
- APIキー等の認証情報は不要（国土地理院APIは無認証）
- キャッシュファイルには住所情報が含まれるため取り扱い注意

## 最終更新
- 日付: 2024年6月5日
- 更新者: AI Assistant
- バージョン: 1.0

## 関連ドキュメント
- README.md: 基本的な使用方法
- 市区町村マッピング.json: データ仕様
- requirements.txt: 依存関係 